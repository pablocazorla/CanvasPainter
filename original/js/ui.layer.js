var layerCtrl=function(){return this.init()};layerCtrl.prototype={layerForDocs:[],enabledLayers:!1,heightStick:26,init:function(){var a=this;return this.sliderOpacityLayer=new slider({parent:getById("layer-top-tools"),id:"slider-layer-opacity",title:"Opacity (%)",titleOver:"The opacity of the layer",startDisable:!0,initVal:100,callback:function(){app.currentDoc.setOpacityLayer(a.sliderOpacityLayer.val)}}),onClick("palet-tool-new-layer",function(){a.enabledLayers&&app.currentDoc.addLayer()}),onClick("palet-duplicate-layer",function(){a.enabledLayers&&app.currentDoc.duplicateLayer()}),onClick("palet-merge-layer",function(){a.enabledLayers&&app.currentDoc.mergeLayer()}),onClick("palet-tool-remove-layer",function(){a.enabledLayers&&app.currentDoc.removeLayer()}),this},createLayerDoc:function(a){var b=document.createElement("div");b.className="layer-for-doc",b.id="lfd-"+a.setting.docID,getById("layer-container").appendChild(b),this.layerForDocs.push(b);var c=document.createElement("div");return c.className="layer-drag-indicator",b.appendChild(c),this},removeLayerDoc:function(a,b){return this.layerForDocs.splice(a,1),getById("layer-container").removeChild(getById("lfd-"+b)),this},addLayer:function(a){var b=document.createElement("div"),c=document.createElement("span"),d=document.createElement("span");layerBlocked=document.createElement("span"),layerClipped=document.createElement("span"),b.className="layer-stick",b.id="lay-"+a.id+"-"+app.currentDoc.setting.docID,c.className="layer-stick-eye",d.className="layer-stick-title",d.innerHTML=a.name,layerBlocked.className="layer-stick-option blocked",layerBlocked.title="Block layer",layerClipped.className="layer-stick-option clipped",layerClipped.title="Clip layer";var e=getById("lfd-"+app.currentDoc.setting.docID);return e.appendChild(b),b.appendChild(c),b.appendChild(d),b.appendChild(layerClipped),b.appendChild(layerBlocked),this.setEventSticks(b,c,d,e,layerBlocked,layerClipped),this.setLayerStickPositions(),this},toggleEnabledLayers:function(a){return a&&!this.enabledLayers&&(getById("layer-bottom-tools").className="",this.enabledLayers=!0),!a&&this.enabledLayers&&(getById("layer-bottom-tools").className="disable",this.enabledLayers=!1),this},removeLayer:function(a){return getById("lfd-"+app.currentDoc.setting.docID).removeChild(getById("lay-"+a+"-"+app.currentDoc.setting.docID)),this},setLayerStickPositions:function(){for(var a=0,b=app.currentDoc.length-1;b>=0;b--){var c=app.currentDoc.layers[b],d=getById("lay-"+c.id+"-"+app.currentDoc.setting.docID),e="layer-stick";b==app.currentDoc.currentLayer&&(e+=" current",this.sliderOpacityLayer.update(c.opacity)),c.visible||(e+=" hidden"),c.clipped&&(e+=" clipped"),c.blocked&&(e+=" blocked"),d.className=e,d.style.top=this.heightStick*a+"px",a++}return a++,getById("lfd-"+app.currentDoc.setting.docID).style.height=this.heightStick*a+"px",this},setEventSticks:function(a,b,c,d,e,f){var g=this,h=a.id.split("-")[1],i=!1,j=!1,k=0,l=0,m=0,n=0,o=d.getElementsByClassName("layer-drag-indicator")[0],q=(app.currentDoc.length,""),r=!1,s=function(b){app.currentDoc.setCurrentLayer(h,!0),m=b.pageY-parseInt(window.getComputedStyle(a).getPropertyValue("top")),q=a.className,i=!0},t=function(b){i&&(r||(a.className=q+" dragging",r=!0),j=!0,k=b.pageY-m,a.style.top=k+"px",l=Math.round(k/g.heightStick),o.style.top=l*g.heightStick+"px",n=app.currentDoc.length-1-l)},u=function(){i&&(i=!1,r=!1,a.className=q,o.style.top="-5px"),j&&(j=!1,app.currentDoc.changeLayerPosition(n))};return onClick(b,function(){app.currentDoc.toggleVisibleLayer(h)}),onClick(e,function(){app.currentDoc.toggleBlockedLayer(h)}),onClick(f,function(){app.currentDoc.toggleClippedLayer(h)}),c.addEventListener("mousedown",function(a){s(a)},!1),document.body.addEventListener("mousemove",function(a){t(a)},!1),document.body.addEventListener("mouseup",function(){u()},!1),this}};